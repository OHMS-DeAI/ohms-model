name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt
    - name: Check formatting
      run: cargo fmt --all -- --check

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy
    - name: Lint with clippy
      run: cargo clippy --all-targets --all-features -- -D warnings

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown
    
    - name: Install dfx
      run: |
        sh -ci "$(curl -fsSL https://internetcomputer.org/install.sh)"
        echo "$HOME/bin" >> $GITHUB_PATH
    
    - name: Start dfx
      run: |
        dfx start --background --clean
    
    - name: Build canister
      run: |
        dfx build --check
    
    - name: Generate Candid
      run: |
        dfx generate
        git diff --exit-code src/ohms_model.did || echo "Candid updated"
    
    - name: Stop dfx
      run: dfx stop

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - name: Run tests
      run: cargo test --verbose

  determinism:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown
    
    - name: Install dfx
      run: |
        sh -ci "$(curl -fsSL https://internetcomputer.org/install.sh)"
        echo "$HOME/bin" >> $GITHUB_PATH
    
    - name: Test deterministic builds
      run: |
        dfx start --background --clean
        dfx build
        cp .dfx/local/canisters/ohms_model/ohms_model.wasm build1.wasm
        dfx build
        cp .dfx/local/canisters/ohms_model/ohms_model.wasm build2.wasm
        diff build1.wasm build2.wasm && echo "Builds are deterministic"
        dfx stop

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - name: Security audit
      run: |
        cargo install cargo-audit || true
        cargo audit --deny warnings || echo "Audit warnings found"

  artifacts:
    runs-on: ubuntu-latest
    needs: [build, test, determinism]
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown
    
    - name: Install dfx
      run: |
        sh -ci "$(curl -fsSL https://internetcomputer.org/install.sh)"
        echo "$HOME/bin" >> $GITHUB_PATH
    
    - name: Build release
      run: |
        dfx start --background --clean
        dfx build
        dfx generate
        dfx stop
    
    - name: Archive artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ohms-model-canister
        path: |
          .dfx/local/canisters/ohms_model/ohms_model.wasm
          src/ohms_model.did
          dfx.json
        retention-days: 30